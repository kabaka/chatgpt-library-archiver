<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Image Gallery</title>
<style>
:root {
  --space: 20px;
  --gap: 15px;
  --bg: #fff;
  --text: #000;
  --meta-color: #444;
  --control-bg: #ddd;
}
*, *::before, *::after {
  box-sizing: border-box;
}
body {
  font-family: sans-serif;
  margin: 0;
  background: var(--bg);
  color: var(--text);
  transition: background 0.3s, color 0.3s;
}
body.dark {
  --bg: #111;
  --text: #eee;
  --meta-color: #ccc;
  --control-bg: #555;
}
.layout {
  width: 100%;
  margin: 0;
  padding: 0 var(--space) var(--space);
}
.gallery-grid {
  display: grid;
  gap: var(--gap);
  grid-template-columns: repeat(auto-fill, minmax(var(--thumb-size, 200px), 1fr));
  grid-auto-rows: var(--thumb-size, 200px);
}
.gallery-small { --thumb-size: 150px; }
.gallery-medium { --thumb-size: 250px; }
.gallery-large { --thumb-size: 400px; }
.gallery-small .meta .created,
.gallery-small .meta .tags { display: none; }
.image-card {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  background: var(--bg);
  height: 100%;
}
.image-card a.thumb {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
}
.image-card img {
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  object-position: center;
  display: block;
}
.meta {
  display: none;
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  max-height: 50%;
  background: rgba(0, 0, 0, 0.6);
  color: #fff;
  font-size: 0.85em;
  padding: 6px;
  box-sizing: border-box;
  overflow: hidden;
}
.image-card:hover .meta { display: block; }
.meta a { color: #fff; text-decoration: underline; }
.meta .tags {
  font-size: 0.7em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
header.top-bar {
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 100;
  padding: 10px var(--space);
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
}
header.top-bar h1 {
  margin: 0;
  font-size: 1.2em;
}
.controls {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin: 0 0 0 auto;
}
.toggle, .size-select {
  background: var(--control-bg);
  border-radius: 5px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 0.9em;
}
.search-bar {
  display: flex;
  gap: 10px;
  align-items: center;
}
header.top-bar .search-bar {
  flex: 1;
  margin: 0;
}
.search-bar input {
  padding: 6px;
  font-size: 1em;
}
.search-bar input[type="text"] {
  width: 200px;
}
@media (prefers-color-scheme: dark) {
  body:not(.light) {
    --bg: #111;
    --text: #eee;
    --meta-color: #ccc;
    --control-bg: #555;
  }
}
#viewer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  align-items: center;
  justify-content: center;
}
#viewer img {
  max-width: 90%;
  max-height: 90%;
  width: auto;
  height: auto;
}
#viewer .viewer-meta { position: absolute; bottom: 20px; }
#viewer a {
  color: white;
  background: rgba(0, 0, 0, 0.6);
  padding: 4px 8px;
  border-radius: 4px;
}
</style>
</head>
<body>
  <header class="top-bar">
      <h1>Image Gallery</h1>
      <div class="search-bar">
        <input
          type="text"
          id="searchBox"
          placeholder="Search title or tags (use AND/OR)"
          title="Supports AND, OR, NOT and parentheses"
          oninput="filterGallery()"
        >
        <input type="date" id="startDate" onchange="filterGallery()">
        <input type="date" id="endDate" onchange="filterGallery()">
      </div>
      <div class="controls">
        <div class="size-select">
          <strong>Select Image Size: </strong>
          <select id="sizeSelector" onchange="changeSize()">
            <option value="gallery-small">Small</option>
            <option value="gallery-medium" selected>Medium</option>
            <option value="gallery-large">Large</option>
          </select>
        </div>
        <div class="toggle" onclick="toggleDarkMode()">Toggle Dark Mode</div>
      </div>
  </header>
  <div class="layout">
    <div class="gallery-grid gallery-medium" id="gallery"></div>
  </div>
<div id="viewer">
  <img id="viewerImg" src="" alt="">
  <div class="viewer-meta"><a id="viewerRaw" href="" target="_blank">Raw file</a></div>
</div>
<script>
async function loadImages() {
  const response = await fetch('metadata.json');
  const data = await response.json();
  const gallery = document.getElementById('gallery');
  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        obs.unobserve(img);
      }
    });
  });
  data.forEach(item => {
    const card = document.createElement('div');
    card.className = 'image-card';
    const title = item.title || '';
    card.dataset.title = title.toLowerCase();
    card.dataset.created = item.created_at ? String(item.created_at * 1000) : '';
    const tagsArr = item.tags || [];
    card.dataset.tags = tagsArr.map(t => t.toLowerCase()).join('\n');
    const imgPath = 'images/' + item.filename;
    const created = item.created_at
      ? new Date(item.created_at * 1000)
          .toISOString()
          .replace('T', ' ')
          .split('.')[0]
      : '';
    const tagsSnippet = tagsArr.slice(0, 5).join(', ');
    const extra = tagsArr.length > 5 ? 'â€¦' : '';
    const tagsHtml =
      tagsSnippet
        ? '<span class="tags"><br>' + tagsSnippet + extra + '</span>'
        : '';
    card.innerHTML =
      '<a href="' + imgPath + '" class="thumb">' +
      '<img data-src="' + imgPath + '" alt="' + title + '" loading="lazy"></a>' +
      '<div class="meta"><strong>' + (title || item.id) + '</strong>' +
      '<span class="created"><br>' + created + '</span>' +
      tagsHtml + '<br><a href="' +
      (item.conversation_link || '#') +
      '" target="_blank">View conversation</a></div>';
    const tagsSpan = card.querySelector('.tags');
    if (tagsSpan) {
      tagsSpan.title = tagsArr.join(', ');
    }
    const index = viewerData.push({ src: imgPath, title: title || item.id }) - 1;
    card.dataset.index = String(index);
    gallery.appendChild(card);
    const link = card.querySelector('a.thumb');
    link.addEventListener('click', e => {
      if (e.ctrlKey || e.metaKey) {
        return;
      }
      e.preventDefault();
      openViewer(index);
    });
    const img = card.querySelector('img');
    observer.observe(img);
  });
  updateVisibleIndices();
}
function toggleDarkMode() {
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const isDark =
    document.body.classList.contains('dark') ||
    (!document.body.classList.contains('light') && prefersDark);
  if (isDark) {
    document.body.classList.remove('dark');
    document.body.classList.add('light');
    localStorage.setItem('theme', 'light');
  } else {
    document.body.classList.remove('light');
    document.body.classList.add('dark');
    localStorage.setItem('theme', 'dark');
  }
}
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark') {
  document.body.classList.add('dark');
} else if (savedTheme === 'light') {
  document.body.classList.add('light');
}
function filterGallery() {
  const text = document.getElementById('searchBox').value.toLowerCase();
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  const startMs = start ? new Date(start).getTime() : null;
  const endMs = end ? new Date(end).getTime() : null;
  const cards = document.querySelectorAll('.image-card');
  const searchFn = text ? makeSearchFn(text) : () => true;
  cards.forEach(card => {
    const created = card.dataset.created ? parseInt(card.dataset.created) : null;
    const matchesText = searchFn(card);
    const matchesStart = startMs === null || (created && created >= startMs);
    const matchesEnd = endMs === null || (created && created <= endMs);
    card.style.display =
      matchesText && matchesStart && matchesEnd ? '' : 'none';
  });
  updateVisibleIndices();
}

function tokenize(expr) {
  const tokens = [];
  const re = /\s*(\(|\)|AND|OR|NOT|[^()\s]+)\s*/gi;
  let m;
  while ((m = re.exec(expr)) !== null) {
    tokens.push(m[1].toLowerCase());
  }
  return tokens;
}

function makeSearchFn(expr) {
  const tokens = tokenize(expr);
  let i = 0;
  function parseExpr() {
    let node = parseTerm();
    while (tokens[i] === 'or') {
      i++;
      const rhs = parseTerm();
      const lhs = node;
      node = card => lhs(card) || rhs(card);
    }
    return node;
  }
  function parseTerm() {
    let node = parseFactor();
    while (tokens[i] === 'and') {
      i++;
      const rhs = parseFactor();
      const lhs = node;
      node = card => lhs(card) && rhs(card);
    }
    return node;
  }
  function parseFactor() {
    const token = tokens[i++];
    if (token === 'not') {
      const fn = parseFactor();
      return card => !fn(card);
    }
    if (token === '(') {
      const fn = parseExpr();
      if (tokens[i] === ')') i++;
      return fn;
    }
    if (token && token !== ')' && token !== 'and' && token !== 'or') {
      return card =>
        (card.dataset.title && card.dataset.title.includes(token)) ||
        (card.dataset.tags && card.dataset.tags.includes(token));
    }
    return () => true;
  }
  return parseExpr();
}
function changeSize() {
  const gallery = document.getElementById('gallery');
  gallery.className = 'gallery-grid ' +
    document.getElementById('sizeSelector').value;
}
let viewerData = [];
let visibleIndices = [];
let currentIndex = 0;

function updateVisibleIndices() {
  const cards = document.querySelectorAll('.image-card');
  visibleIndices = Array.from(cards)
    .filter(card => card.style.display !== 'none')
    .map(card => parseInt(card.dataset.index));
}

function showViewerAt(pos) {
  currentIndex = pos;
  const index = visibleIndices[pos];
  const item = viewerData[index];
  const viewer = document.getElementById('viewer');
  const img = document.getElementById('viewerImg');
  const raw = document.getElementById('viewerRaw');
  viewer.style.display = 'flex';
  img.src = item.src;
  img.alt = item.title;
  raw.href = item.src;
}

function openViewer(index) {
  updateVisibleIndices();
  const pos = visibleIndices.indexOf(index);
  if (pos === -1) return;
  showViewerAt(pos);
}
function closeViewer() {
  document.getElementById('viewer').style.display = 'none';
}
function showNext(delta) {
  const total = visibleIndices.length;
  if (!total) return;
  const nextPos = (currentIndex + delta + total) % total;
  showViewerAt(nextPos);
}
document.addEventListener('keydown', e => {
  const viewer = document.getElementById('viewer');
  if (viewer.style.display !== 'flex') return;
  if (e.key === 'Escape') {
    closeViewer();
  } else if (e.key === 'ArrowRight') {
    showNext(1);
  } else if (e.key === 'ArrowLeft') {
    showNext(-1);
  }
});
loadImages();
</script>
</body></html>
