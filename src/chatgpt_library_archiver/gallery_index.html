<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Image Gallery</title>
<style>
:root {
  --space: 20px;
  --gap: 15px;
  --max-width: 1200px;
  --bg: #fff;
  --text: #000;
  --card-bg: #fff;
  --meta-color: #444;
  --control-bg: #ddd;
}
body {
  font-family: sans-serif;
  margin: var(--space);
  background: var(--bg);
  color: var(--text);
  transition: background 0.3s, color 0.3s;
}
body.dark {
  --bg: #111;
  --text: #eee;
  --card-bg: #222;
  --meta-color: #ccc;
  --control-bg: #555;
}
.layout {
  max-width: var(--max-width);
  margin: 0 auto;
}
.gallery-grid {
  display: grid;
  gap: var(--gap);
  grid-template-columns: repeat(auto-fill, minmax(var(--thumb-size, 200px), 1fr));
}
.gallery-small { --thumb-size: 150px; }
.gallery-medium { --thumb-size: 250px; }
.gallery-large { --thumb-size: 400px; }
.image-card {
  border: 1px solid #ccc;
  padding: 8px;
  border-radius: 8px;
  font-size: 0.85em;
  background: var(--card-bg);
}
img { width: 100%; border-radius: 4px; display: block; }
.meta { margin-top: 6px; color: var(--meta-color); }
h1 { margin-bottom: 10px; }
.controls {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-bottom: 15px;
}
.toggle, .size-select {
  background: var(--control-bg);
  border-radius: 5px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 0.9em;
}
.search-bar {
  margin-bottom: 15px;
  display: flex;
  gap: 10px;
  align-items: center;
}
.search-bar input {
  padding: 6px;
  font-size: 1em;
}
.search-bar input[type="text"] {
  width: 200px;
}
@media (prefers-color-scheme: dark) {
  body:not(.light) {
    --bg: #111;
    --text: #eee;
    --card-bg: #222;
    --meta-color: #ccc;
    --control-bg: #555;
  }
}
#viewer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  align-items: center;
  justify-content: center;
}
#viewer img {
  max-width: 90%;
  max-height: 90%;
  width: auto;
  height: auto;
}
#viewer .viewer-meta { position: absolute; bottom: 20px; }
#viewer a {
  color: white;
  background: rgba(0, 0, 0, 0.6);
  padding: 4px 8px;
  border-radius: 4px;
}
</style>
</head>
<body>
<div class="layout">
  <div class="controls">
    <div class="size-select">
      <strong>Select Image Size: </strong>
      <select id="sizeSelector" onchange="changeSize()">
        <option value="gallery-small">Small</option>
        <option value="gallery-medium" selected>Medium</option>
        <option value="gallery-large">Large</option>
      </select>
    </div>
    <div class="toggle" onclick="toggleDarkMode()">Toggle Dark Mode</div>
  </div>
  <h1>Image Gallery</h1>
  <div class="search-bar">
    <input
      type="text"
      id="searchBox"
      placeholder="Search by title..."
      oninput="filterGallery()"
    >
    <input type="date" id="startDate" onchange="filterGallery()">
    <input type="date" id="endDate" onchange="filterGallery()">
  </div>
  <div class="gallery-grid gallery-medium" id="gallery"></div>
</div>
<div id="viewer">
  <img id="viewerImg" src="" alt="">
  <div class="viewer-meta"><a id="viewerRaw" href="" target="_blank">Raw file</a></div>
</div>
<script>
async function loadImages() {
  const response = await fetch('metadata.json');
  const data = await response.json();
  const gallery = document.getElementById('gallery');
  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        obs.unobserve(img);
      }
    });
  });
  data.forEach(item => {
    const card = document.createElement('div');
    card.className = 'image-card';
    const title = item.title || '';
    card.dataset.title = title.toLowerCase();
    card.dataset.created = item.created_at ? String(item.created_at * 1000) : '';
    const tagsArr = item.tags || [];
    const imgPath = 'images/' + item.filename;
    const created = item.created_at
      ? new Date(item.created_at * 1000)
          .toISOString()
          .replace('T', ' ')
          .split('.')[0]
      : '';
    const tags = tagsArr.join(', ') || 'â€”';
    card.innerHTML =
      '<a href="' + imgPath + '" class="thumb">' +
      '<img data-src="' + imgPath + '" alt="' + title + '" loading="lazy"></a>' +
      '<div class="meta"><strong>' + (title || item.id) + '</strong><br>' +
      created + '<br>' +
      'Tags: ' + tags + '<br><a href="' +
      (item.conversation_link || '#') +
      '" target="_blank">View conversation</a></div>';
    const index = viewerData.push({ src: imgPath, title: title || item.id }) - 1;
    card.dataset.index = String(index);
    gallery.appendChild(card);
    const link = card.querySelector('a.thumb');
    link.addEventListener('click', e => {
      if (e.ctrlKey || e.metaKey) {
        return;
      }
      e.preventDefault();
      openViewer(index);
    });
    const img = card.querySelector('img');
    observer.observe(img);
  });
  updateVisibleIndices();
}
function toggleDarkMode() {
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const isDark =
    document.body.classList.contains('dark') ||
    (!document.body.classList.contains('light') && prefersDark);
  if (isDark) {
    document.body.classList.remove('dark');
    document.body.classList.add('light');
    localStorage.setItem('theme', 'light');
  } else {
    document.body.classList.remove('light');
    document.body.classList.add('dark');
    localStorage.setItem('theme', 'dark');
  }
}
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark') {
  document.body.classList.add('dark');
} else if (savedTheme === 'light') {
  document.body.classList.add('light');
}
function filterGallery() {
  const text = document.getElementById('searchBox').value.toLowerCase();
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  const startMs = start ? new Date(start).getTime() : null;
  const endMs = end ? new Date(end).getTime() : null;
  const cards = document.querySelectorAll('.image-card');
  cards.forEach(card => {
    const title = card.dataset.title;
    const created = card.dataset.created ? parseInt(card.dataset.created) : null;
    const matchesText = title.includes(text);
    const matchesStart = startMs === null || (created && created >= startMs);
    const matchesEnd = endMs === null || (created && created <= endMs);
    card.style.display =
      matchesText && matchesStart && matchesEnd ? '' : 'none';
  });
  updateVisibleIndices();
}
function changeSize() {
  const gallery = document.getElementById('gallery');
  gallery.className = 'gallery-grid ' +
    document.getElementById('sizeSelector').value;
}
let viewerData = [];
let visibleIndices = [];
let currentIndex = 0;

function updateVisibleIndices() {
  const cards = document.querySelectorAll('.image-card');
  visibleIndices = Array.from(cards)
    .filter(card => card.style.display !== 'none')
    .map(card => parseInt(card.dataset.index));
}

function showViewerAt(pos) {
  currentIndex = pos;
  const index = visibleIndices[pos];
  const item = viewerData[index];
  const viewer = document.getElementById('viewer');
  const img = document.getElementById('viewerImg');
  const raw = document.getElementById('viewerRaw');
  viewer.style.display = 'flex';
  img.src = item.src;
  img.alt = item.title;
  raw.href = item.src;
}

function openViewer(index) {
  updateVisibleIndices();
  const pos = visibleIndices.indexOf(index);
  if (pos === -1) return;
  showViewerAt(pos);
}
function closeViewer() {
  document.getElementById('viewer').style.display = 'none';
}
function showNext(delta) {
  const total = visibleIndices.length;
  if (!total) return;
  const nextPos = (currentIndex + delta + total) % total;
  showViewerAt(nextPos);
}
document.addEventListener('keydown', e => {
  const viewer = document.getElementById('viewer');
  if (viewer.style.display !== 'flex') return;
  if (e.key === 'Escape') {
    closeViewer();
  } else if (e.key === 'ArrowRight') {
    showNext(1);
  } else if (e.key === 'ArrowLeft') {
    showNext(-1);
  }
});
loadImages();
</script>
</body></html>
