<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Image Gallery</title>
<style>
:root {
  --space: 20px;
  --gap: 15px;
  --bg: #fff;
  --text: #000;
  --meta-color: #444;
  --control-bg: #ddd;
}
*, *::before, *::after {
  box-sizing: border-box;
}
body {
  font-family: sans-serif;
  margin: 0;
  background: var(--bg);
  color: var(--text);
  transition: background 0.3s, color 0.3s;
}
body.dark {
  --bg: #111;
  --text: #eee;
  --meta-color: #ccc;
  --control-bg: #555;
}
.layout {
  width: 100%;
  margin: 0;
  padding: 0 var(--space) var(--space);
}
.gallery-grid {
  display: grid;
  gap: var(--gap);
  grid-template-columns: repeat(auto-fill, minmax(var(--thumb-size, 200px), 1fr));
  grid-auto-rows: var(--thumb-size, 200px);
}
.gallery-full {
  display: flex;
  flex-direction: column;
  gap: var(--gap);
}
.gallery-small { --thumb-size: 150px; }
.gallery-medium { --thumb-size: 250px; }
.gallery-large { --thumb-size: 400px; }
.gallery-full .image-card,
.gallery-full .image-card a.thumb {
  height: auto;
}
.gallery-full .image-card img {
  width: 100%;
  height: auto;
  max-width: none;
  max-height: none;
  object-fit: contain;
  object-position: center;
}
.gallery-small .meta .created,
.gallery-small .meta .tags { display: none; }
.image-card {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  background: var(--bg);
  height: 100%;
}
.image-card a.thumb {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
}
.image-card img {
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  object-position: center;
  display: block;
}
.meta {
  display: none;
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  max-height: 50%;
  background: rgba(0, 0, 0, 0.6);
  color: #fff;
  font-size: 0.85em;
  padding: 6px;
  box-sizing: border-box;
  overflow: hidden;
}
.image-card:hover .meta { display: block; }
.meta a { color: #fff; text-decoration: underline; }
.meta .tags {
  font-size: 0.7em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
header.top-bar {
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 100;
  padding: 10px var(--space);
  width: 100%;
  display: grid;
  grid-template-columns: auto minmax(0, 1fr) auto;
  grid-template-areas: "title search controls";
  gap: 10px;
  align-items: center;
}
header.top-bar h1 {
  margin: 0;
  font-size: 1.2em;
  grid-area: title;
}
.controls {
  display: inline-flex;
  justify-content: flex-end;
  gap: 8px;
  margin: 0;
  grid-area: controls;
}
.toggle, .size-select {
  background: var(--control-bg);
  border-radius: 5px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 0.9em;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.search-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}
header.top-bar .search-bar {
  grid-area: search;
  margin: 0;
}
.search-bar input {
  padding: 7px;
  font-size: 1em;
}
.search-bar input[type="text"] {
  flex: 1 1 200px;
  min-width: 140px;
  max-width: 100%;
}
.search-bar button {
  background: var(--control-bg);
  border: none;
  border-radius: 5px;
  padding: 7px;
  cursor: pointer;
}
.search-bar .help-icon {
  background: var(--control-bg);
  border-radius: 50%;
  cursor: help;
  display: inline-block;
  font-size: 0.8em;
  font-weight: bold;
  height: 20px;
  line-height: 20px;
  text-align: center;
  width: 20px;
}
.date-range {
  display: inline-flex;
  gap: 6px;
  align-items: center;
  font-size: 0.9em;
}
.date-range input {
  padding: 5px 6px;
}
.date-range span {
  white-space: nowrap;
}
.reset-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 32px;
}
.icon-link {
  display: flex;
  align-items: center;
}
.icon-link svg {
  width: 20px;
  height: 20px;
  fill: currentColor;
}
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}
@media (prefers-color-scheme: dark) {
  body:not(.light) {
    --bg: #111;
    --text: #eee;
    --meta-color: #ccc;
    --control-bg: #555;
  }
}
@media (max-width: 960px) {
  header.top-bar {
    padding: 8px calc(var(--space) * 0.75);
    gap: 8px;
  }
  header.top-bar h1 {
    font-size: 1.1em;
  }
  .toggle, .size-select, .search-bar button {
    padding: 6px 8px;
    font-size: 0.9em;
  }
  .controls {
    gap: 6px;
  }
}
@media (max-width: 680px) {
  header.top-bar {
    grid-template-columns: minmax(0, 1fr);
    grid-template-areas:
      "search"
      "controls";
    align-items: stretch;
  }
  header.top-bar h1 {
    display: none;
  }
  .controls {
    display: flex;
    justify-content: flex-start;
    gap: 8px;
    width: 100%;
    flex-wrap: wrap;
  }
  header.top-bar .search-bar {
    width: 100%;
    display: grid;
    grid-template-columns: minmax(0, 1fr) auto;
    grid-template-areas:
      "query help"
      "dates dates";
    column-gap: 8px;
    row-gap: 10px;
  }
  .search-bar input[type="text"] {
    grid-area: query;
    min-width: 0;
  }
  .search-bar .help-icon {
    grid-area: help;
    justify-self: end;
    align-self: center;
  }
  .date-range {
    grid-area: dates;
    width: 100%;
    display: grid;
    grid-template-columns: auto minmax(0, 1fr) minmax(0, 1fr) auto;
    column-gap: 6px;
    align-items: center;
  }
  .date-range input {
    min-width: 0;
  }
  .toggle, .size-select {
    font-size: 0.95em;
  }
  .reset-button {
    justify-self: end;
    padding: 7px 8px;
    font-size: 0.95em;
  }
  .controls .toggle,
  .controls .icon-link {
    display: none;
  }
}
#viewer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  align-items: center;
  justify-content: center;
}
#viewer img {
  max-width: 90%;
  max-height: 90%;
  width: auto;
  height: auto;
}
#viewer .viewer-meta { position: absolute; bottom: 20px; }
#viewer a {
  color: white;
  background: rgba(0, 0, 0, 0.6);
  padding: 4px 8px;
  border-radius: 4px;
}
</style>
</head>
<body>
  <header class="top-bar">
      <h1>Image Gallery</h1>
      <div class="search-bar">
        <input
          type="text"
          id="searchBox"
          placeholder="Search images"
          aria-describedby="searchHelp"
          oninput="filterGallery()"
        >
        <span
          id="searchHelp"
          class="help-icon"
          tabindex="0"
          title="Use AND, OR, NOT, and parentheses to refine search."
        >?</span>
        <div class="date-range">
          <span>Date range:</span>
          <input type="date" id="startDate" aria-label="Start date" onchange="filterGallery()">
          <input type="date" id="endDate" aria-label="End date" onchange="filterGallery()">
          <button type="button" id="resetFilters" class="reset-button" onclick="resetFilters()" title="Reset filters">‚ü≤<span class="sr-only">Reset filters</span></button>
        </div>
      </div>
      <div class="controls">
        <div class="size-select">
          <strong>Select Image Size: </strong>
          <select id="sizeSelector" onchange="changeSize()">
            <option value="gallery-small">Small</option>
            <option value="gallery-medium" selected>Medium</option>
            <option value="gallery-large">Large</option>
            <option value="gallery-full">Full size</option>
          </select>
        </div>
        <div class="toggle" onclick="toggleDarkMode()">Toggle Dark Mode</div>
        <a class="icon-link" href="https://github.com/kabaka/chatgpt-library-archiver" target="_blank" rel="noopener" title="GitHub project">
          <svg role="img" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.387.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61-.546-1.387-1.333-1.758-1.333-1.758-1.09-.744.083-.729.083-.729 1.205.084 1.84 1.236 1.84 1.236 1.07 1.835 2.807 1.305 3.492.998.108-.776.418-1.305.762-1.605-2.665-.305-5.466-1.332-5.466-5.93 0-1.31.467-2.381 1.235-3.221-.124-.303-.535-1.523.117-3.176 0 0 1.008-.322 3.3 1.23a11.52 11.52 0 0 1 3-.405c1.02.005 2.045.138 3 .405 2.29-1.552 3.296-1.23 3.296-1.23.653 1.653.242 2.873.118 3.176.77.84 1.233 1.911 1.233 3.221 0 4.61-2.807 5.624-5.479 5.921.43.37.823 1.102.823 2.222 0 1.606-.014 2.898-.014 3.293 0 .319.218.694.825.576C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
          <span class="sr-only">GitHub project</span>
        </a>
      </div>
  </header>
  <div class="layout">
    <div class="gallery gallery-grid gallery-medium" id="gallery"></div>
  </div>
<div id="viewer">
  <img id="viewerImg" src="" alt="">
  <div class="viewer-meta"><a id="viewerRaw" href="" target="_blank">Raw file</a></div>
</div>
<script>
const sizeClassToKey = {
  'gallery-small': 'small',
  'gallery-medium': 'medium',
  'gallery-large': 'large',
  'gallery-full': 'full',
};

function currentSizeKey() {
  const selector = document.getElementById('sizeSelector');
  const className = selector ? selector.value : 'gallery-medium';
  return sizeClassToKey[className] || 'medium';
}

function resolveThumbnails(item, fallback, fullSrc) {
  const thumbs = item.thumbnails || {};
  return {
    small: thumbs.small || fallback,
    medium: thumbs.medium || fallback,
    large: thumbs.large || fallback,
    full: thumbs.full || fullSrc,
  };
}

async function loadImages() {
  const response = await fetch('metadata.json');
  const data = await response.json();
  const gallery = document.getElementById('gallery');
  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        obs.unobserve(img);
      }
    });
  }, { rootMargin: '200px 0px' });
  data.forEach(item => {
    const card = document.createElement('div');
    card.className = 'image-card';
    const title = item.title || '';
    card.dataset.title = title.toLowerCase();
    card.dataset.created = item.created_at ? String(item.created_at * 1000) : '';
    const tagsArr = item.tags || [];
    card.dataset.tags = tagsArr.map(t => t.toLowerCase()).join('\n');
    const imgPath = 'images/' + item.filename;
    const fallbackThumb = item.thumbnail ? item.thumbnail : imgPath;
    const thumbPaths = resolveThumbnails(item, fallbackThumb, imgPath);
    const thumbKey = currentSizeKey();
    const thumbPath = thumbPaths[thumbKey];
    const created = item.created_at
      ? new Date(item.created_at * 1000)
          .toISOString()
          .replace('T', ' ')
          .split('.')[0]
      : '';
    const tagsSnippet = tagsArr.slice(0, 5).join(', ');
    const extra = tagsArr.length > 5 ? '‚Ä¶' : '';
    const tagsHtml =
      tagsSnippet
        ? '<span class="tags"><br>' + tagsSnippet + extra + '</span>'
        : '';
    card.innerHTML =
      '<a href="' + imgPath + '" class="thumb">' +
      '<img data-src="' + thumbPath + '" data-thumb-small="' + thumbPaths.small + '" data-thumb-medium="' + thumbPaths.medium + '" data-thumb-large="' + thumbPaths.large + '" data-thumb-full="' + thumbPaths.full + '" data-full="' + imgPath + '" alt="' + title + '" loading="lazy"></a>' +
      '<div class="meta"><strong>' + (title || item.id) + '</strong>' +
      '<span class="created"><br>' + created + '</span>' +
      tagsHtml + '<br><a href="' +
      (item.conversation_link || '#') +
      '" target="_blank">View conversation</a></div>';
    const tagsSpan = card.querySelector('.tags');
    if (tagsSpan) {
      tagsSpan.title = tagsArr.join(', ');
    }
    const index =
      viewerData.push({
        src: imgPath,
        thumb: thumbPath,
        thumbs: thumbPaths,
        title: title || item.id,
      }) - 1;
    card.dataset.index = String(index);
    gallery.appendChild(card);
    const link = card.querySelector('a.thumb');
    link.addEventListener('click', e => {
      if (e.ctrlKey || e.metaKey) {
        return;
      }
      e.preventDefault();
      openViewer(index);
    });
    const img = card.querySelector('img');
    observer.observe(img);
  });
  updateVisibleIndices();
}
function toggleDarkMode() {
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const isDark =
    document.body.classList.contains('dark') ||
    (!document.body.classList.contains('light') && prefersDark);
  if (isDark) {
    document.body.classList.remove('dark');
    document.body.classList.add('light');
    if (typeof sessionStorage !== 'undefined') {
      sessionStorage.setItem('theme', 'light');
    }
  } else {
    document.body.classList.remove('light');
    document.body.classList.add('dark');
    if (typeof sessionStorage !== 'undefined') {
      sessionStorage.setItem('theme', 'dark');
    }
  }
}
const savedTheme = sessionStorage.getItem('theme');
if (savedTheme === 'dark') {
  document.body.classList.add('dark');
} else if (savedTheme === 'light') {
  document.body.classList.add('light');
}
const savedSize = sessionStorage.getItem('size');
if (savedSize) {
  document.getElementById('sizeSelector').value = savedSize;
  if (savedSize === 'gallery-full') {
    document.getElementById('gallery').className = 'gallery gallery-full';
  } else {
    document.getElementById('gallery').className = 'gallery gallery-grid ' + savedSize;
  }
}
const savedText = sessionStorage.getItem('filter-text') || '';
const savedStart = sessionStorage.getItem('filter-start') || '';
const savedEnd = sessionStorage.getItem('filter-end') || '';
document.getElementById('searchBox').value = savedText;
document.getElementById('startDate').value = savedStart;
document.getElementById('endDate').value = savedEnd;
function filterGallery() {
  const textEl = document.getElementById('searchBox');
  const startEl = document.getElementById('startDate');
  const endEl = document.getElementById('endDate');
  const text = textEl.value.toLowerCase();
  const start = startEl.value;
  const end = endEl.value;
  if (typeof sessionStorage !== 'undefined') {
    sessionStorage.setItem('filter-text', textEl.value);
    sessionStorage.setItem('filter-start', start);
    sessionStorage.setItem('filter-end', end);
  }
  const startMs = start ? new Date(start).getTime() : null;
  const endMs = end ? new Date(end).getTime() : null;
  const cards = document.querySelectorAll('.image-card');
  const searchFn = text ? makeSearchFn(text) : () => true;
  cards.forEach(card => {
    const created = card.dataset.created ? parseInt(card.dataset.created) : null;
    const matchesText = searchFn(card);
    const matchesStart = startMs === null || (created && created >= startMs);
    const matchesEnd = endMs === null || (created && created <= endMs);
    card.style.display =
      matchesText && matchesStart && matchesEnd ? '' : 'none';
  });
  updateVisibleIndices();
}

function tokenize(expr) {
  const tokens = [];
  const re = /\s*(\(|\)|AND|OR|NOT|[^()\s]+)\s*/gi;
  let m;
  while ((m = re.exec(expr)) !== null) {
    tokens.push(m[1].toLowerCase());
  }
  return tokens;
}

function makeSearchFn(expr) {
  const tokens = tokenize(expr);
  let i = 0;
  function parseExpr() {
    let node = parseTerm();
    while (tokens[i] === 'or') {
      i++;
      const rhs = parseTerm();
      const lhs = node;
      node = card => lhs(card) || rhs(card);
    }
    return node;
  }
  function parseTerm() {
    let node = parseFactor();
    while (tokens[i] === 'and') {
      i++;
      const rhs = parseFactor();
      const lhs = node;
      node = card => lhs(card) && rhs(card);
    }
    return node;
  }
  function parseFactor() {
    const token = tokens[i++];
    if (token === 'not') {
      const fn = parseFactor();
      return card => !fn(card);
    }
    if (token === '(') {
      const fn = parseExpr();
      if (tokens[i] === ')') i++;
      return fn;
    }
    if (token && token !== ')' && token !== 'and' && token !== 'or') {
      return card =>
        (card.dataset.title && card.dataset.title.includes(token)) ||
        (card.dataset.tags && card.dataset.tags.includes(token));
    }
    return () => true;
  }
  return parseExpr();
}
function updateThumbnailsForSize(sizeKey) {
  const images = document.querySelectorAll('.image-card img');
  images.forEach(img => {
    let nextSrc = img.dataset[`thumb${sizeKey.charAt(0).toUpperCase() + sizeKey.slice(1)}`];
    if (!nextSrc) {
      nextSrc = img.dataset.src;
    }
    if (!nextSrc) return;
    img.dataset.src = nextSrc;
    if (img.hasAttribute('src')) {
      img.src = nextSrc;
    }
  });
  viewerData = viewerData.map(item => {
    if (!item.thumbs) return item;
    const updated = { ...item };
    updated.thumb = item.thumbs[sizeKey] || item.thumb;
    return updated;
  });
}

function changeSize() {
  const gallery = document.getElementById('gallery');
  const size = document.getElementById('sizeSelector').value;
  if (size === 'gallery-full') {
    gallery.className = 'gallery gallery-full';
  } else {
    gallery.className = 'gallery gallery-grid ' + size;
  }
  if (typeof sessionStorage !== 'undefined') {
    sessionStorage.setItem('size', size);
  }
  const sizeKey = sizeClassToKey[size] || 'medium';
  updateThumbnailsForSize(sizeKey);
}
function resetFilters() {
  const textEl = document.getElementById('searchBox');
  const startEl = document.getElementById('startDate');
  const endEl = document.getElementById('endDate');
  textEl.value = '';
  startEl.value = '';
  endEl.value = '';
  if (typeof sessionStorage !== 'undefined') {
    sessionStorage.removeItem('filter-text');
    sessionStorage.removeItem('filter-start');
    sessionStorage.removeItem('filter-end');
  }
  filterGallery();
}
let viewerData = [];
let visibleIndices = [];
let currentIndex = 0;
let justSwiped = false;
let touchStartX = 0;
let touchStartY = 0;

function updateVisibleIndices() {
  const cards = document.querySelectorAll('.image-card');
  visibleIndices = Array.from(cards)
    .filter(card => card.style.display !== 'none')
    .map(card => parseInt(card.dataset.index));
}

function showViewerAt(pos) {
  currentIndex = pos;
  const index = visibleIndices[pos];
  const item = viewerData[index];
  const viewer = document.getElementById('viewer');
  const img = document.getElementById('viewerImg');
  const raw = document.getElementById('viewerRaw');
  viewer.style.display = 'flex';
  img.src = item.src;
  img.alt = item.title;
  raw.href = item.src;
}

function openViewer(index) {
  updateVisibleIndices();
  const pos = visibleIndices.indexOf(index);
  if (pos === -1) return;
  showViewerAt(pos);
}
function closeViewer() {
  document.getElementById('viewer').style.display = 'none';
  justSwiped = false;
}
function showNext(delta) {
  const total = visibleIndices.length;
  if (!total) return;
  const nextPos = (currentIndex + delta + total) % total;
  showViewerAt(nextPos);
}
document.addEventListener('keydown', e => {
  const viewer = document.getElementById('viewer');
  if (viewer.style.display !== 'flex') return;
  if (e.key === 'Escape') {
    closeViewer();
  } else if (e.key === 'ArrowRight') {
    showNext(1);
  } else if (e.key === 'ArrowLeft') {
    showNext(-1);
  }
});
const viewer = document.getElementById('viewer');
viewer.addEventListener('click', () => {
  if (justSwiped) {
    justSwiped = false;
    return;
  }
  closeViewer();
});
viewer.addEventListener('touchstart', e => {
  if (e.touches.length !== 1) return;
  const touch = e.touches[0];
  touchStartX = touch.clientX;
  touchStartY = touch.clientY;
  justSwiped = false;
});
viewer.addEventListener('touchend', e => {
  if (e.changedTouches.length !== 1) return;
  const touch = e.changedTouches[0];
  const dx = touch.clientX - touchStartX;
  const dy = touch.clientY - touchStartY;
  const absDx = Math.abs(dx);
  const absDy = Math.abs(dy);
  const swipeThreshold = 50;
  if (absDx > swipeThreshold && absDx > absDy) {
    showNext(dx < 0 ? 1 : -1);
    justSwiped = true;
  } else {
    closeViewer();
  }
});
loadImages().then(filterGallery);
</script>
</body></html>
